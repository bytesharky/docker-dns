# Docker DNS è½¬å‘å™¨ï¼šå®¿ä¸»æœºè§£æž `.docker` åŸŸå

åœ¨ Docker ä¸­ï¼Œå®¹å™¨ä¹‹é—´é€šå¸¸å¯ä»¥é€šè¿‡å®¹å™¨åäº’ç›¸è®¿é—®ï¼ˆä¾èµ– Docker å†…ç½® DNS `127.0.0.11`ï¼‰ï¼Œä½† **å®¿ä¸»æœºé»˜è®¤æ— æ³•ç›´æŽ¥è§£æžå®¹å™¨å**ã€‚

æœ¬å·¥å…· â€”â€” **Docker DNS è½¬å‘å™¨**ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼šè®©å®¿ä¸»æœºèƒ½ç›´æŽ¥ç”¨ `å®¹å™¨å.docker` è®¿é—®å®¹å™¨æœåŠ¡ï¼Œ**æ— éœ€ç«¯å£æ˜ å°„ã€æ— éœ€ä¿®æ”¹ hosts æ–‡ä»¶**ã€‚

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

* **å®¿ä¸»æœºç›´æŽ¥è§£æžå®¹å™¨å**
  åœ¨å®¿ä¸»æœºä¸Šé€šè¿‡ `å®¹å™¨å.docker` è®¿é—®å®¹å™¨ï¼Œä¾‹å¦‚ï¼š

  ```bash
  curl http://myapp.docker:8080
  ```

* **è½»é‡çº§è½¬å‘é€»è¾‘**

  * åŒ¹é… `.docker` åŸŸå â†’ è½¬å‘åˆ° Docker å†…ç½® DNSï¼ˆ`127.0.0.11`ï¼‰è§£æžå®¹å™¨ IPï¼›
  * å…¶ä»–åŸŸå â†’ è¿”å›ž `REFUSED`ï¼Œå®¿ä¸»æœºè‡ªåŠ¨ä½¿ç”¨å…¬å…± DNSï¼Œä¸å½±å“æ­£å¸¸ä¸Šç½‘ã€‚

* **ç½‘å…³è®¿é—®æ”¯æŒ**

  é»˜è®¤æä¾› `gateway.docker` åŸŸåï¼Œå¯è§£æžä¸ºå®¿ä¸»æœº IPï¼ˆå¯é€šè¿‡çŽ¯å¢ƒå˜é‡ `GATEWAY` ä¿®æ”¹ï¼‰ã€‚

* **ä½Žèµ„æºå ç”¨**

  åŸºäºŽ `ldns` åº“ + UDP åè®®ï¼Œä»…ç”¨æžå°‘ CPU å’Œå†…å­˜å³å¯è¿è¡Œã€‚

* **å®¹å™¨å†…ä½¿ç”¨**

  Dockerå†…ç½®çš„DNSæœåŠ¡å™¨ï¼Œä¼šå°†éžå®¹å™¨åçš„åŸŸåè½¬å‘åˆ°å®¿ä¸»æœºçš„DNSæœåŠ¡ï¼Œè¿™å°±æ„å‘³è¿™ä½ ä¹Ÿå¯ä»¥åœ¨Dockerå®¹å™¨ä¸­ä½¿ç”¨ç±»ä¼¼ `gateway.docker` çš„åŸŸåã€‚
  
  Dockerä¼šå°†å®ƒè½¬å‘è‡³å®¿ä¸»æœºé…ç½®çš„DNSæœåŠ¡å™¨ï¼ˆå³è¯¥è½¬å‘å™¨ï¼‰ï¼Œè¯¥è½¬å‘å™¨å…ˆåŽ»é™¤ `.docker` åŽç¼€å˜ä¸ºåˆæ³•å®¹å™¨åï¼Œå†ç”±Dockerå†…ç½®çš„DNSæœåŠ¡å™¨è§£æžå¾—åˆ°IPåœ°å€ï¼Œå¹¶è¿”å›žæœ€ç»ˆç»“æžœã€‚

* **å²è¯—çº§çš„å¤§å°ä¼˜åŒ–**

  é’ˆå¯¹é•œåƒä½“ç§¯è¿›è¡Œå²è¯—çº§çš„ä¼˜åŒ–ï¼Œä»ŽåŽŸæœ¬ 8.73MB åˆ°ç›®å‰ 1.22MB ã€‚

  **åŽŸæ–¹æ¡ˆï¼š** Alpine3.22(8.31MB) + ldnsåº“(360.0KB) + docker-dns(37.3K)ï¼Œæœ€ç»ˆé•œåƒçº¦ä¸º8.73MBã€‚

  **æ–°æ–¹æ¡ˆï¼š** Scratch(0B) + docker-dns(4.08 MBï¼ŒupxåŽ‹ç¼©åŽ1.22MB)ï¼Œæœ€ç»ˆé•œåƒçº¦ä¸º1.22MBã€‚

  **ä¼˜åŒ–è¿‡ç¨‹ï¼š**

  **ä¼˜åŒ–1ï¼š** ä½¿ç”¨é™æ€ç¼–è¯‘

  **ä¼˜åŒ–2ï¼š** ä¼˜åŒ–ç¼–è¯‘ï¼ŒåŽ»é™¤ç¬¦å·è¡¨

  **ä¼˜åŒ–3ï¼š** ä½¿ç”¨ UPX åŽ‹ç¼©

  **ä¼˜åŒ–4ï¼š** åŸºäºŽ `Scratch` (ç©ºç™½é•œåƒ)

---

## âš ï¸ æ³¨æ„äº‹é¡¹

* Docker **é»˜è®¤ bridge ç½‘ç»œï¼ˆdocker0ï¼‰** ä¸æ”¯æŒå®¹å™¨åäº’é€šï¼Œåªèƒ½é€šè¿‡ IPã€‚

  è¯·ä½¿ç”¨ **è‡ªå®šä¹‰ç½‘ç»œ**ï¼ˆ`docker network create` åˆ›å»ºï¼‰æ‰èƒ½æ­£å¸¸é€šè¿‡å®¹å™¨åè§£æžã€‚

  æœ‰å…³Dockerè‡ªå®šä¹‰ç½‘ç»œçš„å†…å®¹å¯å‚è€ƒDockerå®˜æ–¹è¯´æ˜Žã€‚

* `.docker` åŸŸå **ä¸åŒºåˆ†å¤§å°å†™**ã€‚

---

## ðŸ› ï¸ å·¥ä½œåŽŸç†

```mermaid
graph TD
    A[å®¿ä¸»æœºå‘èµ· DNS æŸ¥è¯¢] --> B{åŸŸåæ˜¯å¦ä»¥ .docker ç»“å°¾?}
    B -->|æ˜¯| C[åŽ»æŽ‰ .docker åŽç¼€ â†’ è½¬å‘è‡³ 127.0.0.11]
    C --> D[è¿”å›žå®¹å™¨ IP ç»™å®¿ä¸»æœº]
    B -->|å¦| E[è¿”å›ž REFUSED]
    E --> F[å®¿ä¸»æœºå°è¯•å…¬å…± DNS è§£æž]
```

## ðŸš€ éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šè„šæœ¬è‡ªåŠ¨åŒ–

ä¸‹è½½å¹¶è¿è¡Œä»“åº“ä¸­çš„ `docker_dns.sh`ï¼ŒæŒ‰æç¤ºå®Œæˆéƒ¨ç½²ã€‚

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

1. æž„å»ºé•œåƒå¹¶è¿è¡Œå®¹å™¨ï¼š

   ```bash
   # å…‹éš†æºä»£ç 
   git clone https://github.com/bytesharky/docker-dns
   # å›½å†…å¯ç”¨é•œåƒï¼š
   # git clone https://gitee.com/bytesharky/docker-dns

   cd docker-dns
   docker build -t docker-dns:static .

   # å¯åŠ¨å®¹å™¨
   # æŒ‚è½½æ—¶åŒºæ•°æ®ï¼ˆéžå¿…é¡»ï¼Œç”¨æ—¥å¿—æ˜¾ç¤ºæœ¬åœ°æ—¶é—´ï¼‰
   # è®¾ç½®æ—¥å¿—çº§åˆ«ï¼ˆéžå¿…é¡»ï¼Œé»˜è®¤ä¸º INFOï¼‰
   docker run -d \
     -e LOG_LEVEL=INFO \
     -e TZ=/zoneinfo/Asia/Shanghai \
     -v /usr/share/zoneinfo:/zoneinfo:ro \
     --network docker-net \
     --name docker-dns \
     -p 53:53/udp \
     --restart always \
     docker-dns:static
   ```

2. é…ç½®å®¿ä¸»æœº DNS

   ç¼–è¾‘ `/etc/resolv.conf`ï¼Œå°† `127.0.0.1` ç½®é¡¶ï¼š

   ```conf
   nameserver 127.0.0.1       # æœ¬åœ°è½¬å‘å™¨
   nameserver 223.5.5.5       # å…¬å…± DNS 1
   nameserver 8.8.8.8         # å…¬å…± DNS 2
   ```

   ï¼ˆå¯é€‰ï¼‰é˜²æ­¢æ–‡ä»¶è¢«ç³»ç»Ÿè¦†ç›–ï¼š

   ```bash
   sudo chattr +i /etc/resolv.conf
   ```

### æ–¹å¼ä¸‰ï¼šä½¿ç”¨æž„å»ºå¥½çš„é•œåƒ

1. æ‹‰å–æˆ‘æž„å»ºå¥½çš„é•œåƒ

   ```bash
   docker pull ccr.ccs.tencentyun.com/sharky/docker-dns:static

   docker tag ccr.ccs.tencentyun.com/sharky/docker-dns:static docker-dns:static
   
   # å¯åŠ¨å®¹å™¨
   # æŒ‚è½½æ—¶åŒºæ•°æ®ï¼ˆéžå¿…é¡»ï¼Œç”¨æ—¥å¿—æ˜¾ç¤ºæœ¬åœ°æ—¶é—´ï¼‰
   # è®¾ç½®æ—¥å¿—çº§åˆ«ï¼ˆéžå¿…é¡»ï¼Œé»˜è®¤ä¸º INFOï¼‰
   docker run -d \
     -e LOG_LEVEL=INFO \
     -e TZ=/zoneinfo/Asia/Shanghai \
     -v /usr/share/zoneinfo:/zoneinfo:ro \
     --network docker-net \
     --name docker-dns \
     -p 53:53/udp \
     --restart always \
     docker-dns:static
   ```

2. é…ç½®å®¿ä¸»æœº DNS

   å‚è€ƒæ–¹å¼äºŒ

---

## âœ… åŠŸèƒ½éªŒè¯

1. **éªŒè¯å®¹å™¨åè§£æž**

   ```bash
   ping -c 3 docker-dns.docker
   ```

   é¢„æœŸè¾“å‡ºï¼ˆIP å³å®¹å™¨å†…ç½‘åœ°å€ï¼‰ï¼š

   ```bash
   PING docker-dns.docker (172.18.0.6): 56 data bytes
   64 bytes from 172.18.0.6: icmp_seq=1 ttl=64 time=0.05 ms
   ```

2. **éªŒè¯å…¬å…±åŸŸåè§£æž**

   ```bash
   ping -c 3 github.com
   ```

   é¢„æœŸè¾“å‡ºï¼ˆå…¬å…± IPï¼‰ï¼š

   ```bash
   PING github.com (140.82.112.4): 56 data bytes
   64 bytes from 140.82.112.4: icmp_seq=1 ttl=51 time=10.2 ms
   ```

---

## æ•…éšœæŽ’é™¤

é€šè¿‡è®¾ç½®çŽ¯å¢ƒå˜é‡ `LOG_LEVEL` æ¥æŽ§åˆ¶ç¨‹åºè¾“å‡ºä¿¡æ¯ã€‚é»˜è®¤ä¸º `INFO`ã€‚

æ”¯æŒçš„çº§åˆ«ï¼š`DEBUG`, `INFO`, `WARN`, `ERROR`, `FATAL`

### æ—¥å¿—çº§åˆ«ï¼ˆDEBUG/INFO/WARN/ERROR/FATALï¼‰è¯´æ˜Žè¡¨

| æ—¥å¿—çº§åˆ« | æ ¸å¿ƒå«ä¹‰ | ä¸¥é‡ç¨‹åº¦ |
|----------|----------|----------|
| 0=>DEBUG    | è°ƒè¯•çº§åˆ«ï¼Œç”¨äºŽå¼€å‘/æµ‹è¯•é˜¶æ®µæ‰“å°è¯¦ç»†è¿è¡Œä¿¡æ¯ï¼Œè¾…åŠ©å®šä½ä»£ç é—®é¢˜ | æœ€ä½Žï¼ˆä»…å¼€å‘çŽ¯å¢ƒå¸¸ç”¨ï¼‰ |
| 1=>INFO     | ä¿¡æ¯çº§åˆ«ï¼Œè®°å½•ç³»ç»Ÿæ­£å¸¸è¿è¡Œçš„å…³é”®çŠ¶æ€ | è¾ƒä½Žï¼ˆç”Ÿäº§çŽ¯å¢ƒå¯å¼€å¯ï¼Œè®°å½•æ­£å¸¸äº‹ä»¶ï¼‰ |
| 2=>WARN     | è­¦å‘Šçº§åˆ«ï¼Œè®°å½•éžè‡´å‘½æ€§å¼‚å¸¸æˆ–æ½œåœ¨é£Žé™©ï¼Œç³»ç»Ÿå¯ç»§ç»­è¿è¡Œ | ä¸­ç­‰ï¼ˆéœ€ç›‘æŽ§ï¼Œå¯èƒ½é¢„ç¤ºåŽç»­é—®é¢˜ï¼‰ |
| 3=>ERROR    | é”™è¯¯çº§åˆ«ï¼Œè®°å½•è‡´å‘½æ€§å¼‚å¸¸ï¼Œå•æ¬¡DNSè§£æžå¤±è´¥ï¼Œä½†ä¸å½±å“ç³»ç»Ÿæ•´ä½“è¿è¡Œ | è¾ƒé«˜ï¼ˆéœ€åŠæ—¶æŽ’æŸ¥ï¼Œé¿å…å½±å“èŒƒå›´æ‰©å¤§ï¼‰ |
| 4=>FATAL    | è‡´å‘½çº§åˆ«ï¼Œè®°å½•å¯¼è‡´ç³»ç»Ÿå®Œå…¨æ— æ³•è¿è¡Œçš„ä¸¥é‡é”™è¯¯ | æœ€é«˜ï¼ˆç³»ç»Ÿä¸å¯ç”¨ï¼Œéœ€ç´§æ€¥å¤„ç†ï¼‰ |

## ðŸ“Œ æ€»ç»“

Docker DNS è½¬å‘å™¨ç›¸å½“äºŽå®¿ä¸»æœºä¸Ž Docker å†…ç½® DNS ä¹‹é—´çš„â€œæ¡¥æ¢â€ï¼Œç‰¹ç‚¹æ˜¯ï¼š

* ðŸŸ¢ å®¿ä¸»æœºå¯æ— ç¼è§£æž `.docker` åŸŸå
* ðŸŸ¢ ä¸å½±å“æ­£å¸¸ä¸Šç½‘è§£æž
* ðŸŸ¢ éƒ¨ç½²ç®€å•ã€å ç”¨æžä½Ž

é€‚ç”¨äºŽï¼š

**å¼€å‘/æµ‹è¯•çŽ¯å¢ƒ**ï¼Œæˆ–å¸Œæœ›å®¿ä¸»æœºç›´æŽ¥é€šè¿‡å®¹å™¨åè®¿é—®æœåŠ¡çš„åœºæ™¯ã€‚

**ç”Ÿäº§çŽ¯å¢ƒ**è°¨æ…Žä½¿ç”¨ï¼Œæ›´æŽ¨èå›ºå®šIPæ–¹å¼ã€‚

## é™„ï¼šå‘½ä»¤è¡Œå‚æ•°/çŽ¯å¢ƒå˜é‡è¯´æ˜Ž

| çŸ­é€‰é¡¹ | é•¿é€‰é¡¹          | çŽ¯å¢ƒå˜é‡         | åŠŸèƒ½è¯´æ˜Ž                                                     | é»˜è®¤å€¼           |
| ------ | --------------- | ---------------- | ------------------------------------------------------------ | ---------------- |
| `-L`   | `--log-level`   | `LOG_LEVEL`      | è®¾ç½®æ—¥å¿—è¾“å‡ºçº§åˆ«ï¼ŒæŽ§åˆ¶æ—¥å¿—çš„è¯¦ç»†ç¨‹åº¦                         | `INFO`           |
| `-G`   | `--gateway`     | `GATEWAY_NAME`   | è®¾ç½®ç½‘å…³åç§°ï¼Œåœ¨Dockerä¸­ç½‘å…³ä¸ºå®¿ä¸»æœºï¼Œè¯¥é€‰é¡¹å…è®¸åœ¨dockerå®¹å™¨ä¸­é€šè¿‡`ç½‘å…³åç§°.åŽç¼€`ï¼Œè‡ªåŠ¨è§£æžåˆ°å®¿ä¸»æœºIPåœ°å€ã€‚ | `gateway`        |
| `-S`   | `--suffix`      | `SUFFIX_DOMAIN`  | è®¾ç½®åŽç¼€åç§°ï¼Œè¦è½¬å‘çš„åŸŸååŽç¼€                               | `.docker`        |
| `-C`   | `--container`   | `CONTAINER_NAME` | è®¾ç½®å®¹å™¨åç§°ï¼Œä»…ç”¨äºŽå¯åŠ¨æœåŠ¡æ—¶å‘è½¬å‘æœåŠ¡å™¨å‘é€`å®¹å™¨å.åŽç¼€`çš„è§£æžè¯·æ±‚ï¼Œä»¥æµ‹è¯•è¿žé€šæ€§ã€‚ | `docker-dns`     |
| `-D`   | `--dns-server`  | `FORWARD_DNS`    | è®¾ç½®è½¬å‘DNSæœåŠ¡å™¨ï¼Œå³è¯¥æœåŠ¡æ”¶åˆ°æŒ‡å®šåŽç¼€çš„DNSæŸ¥è¯¢åŽï¼Œè½¬å‘è¯·æ±‚çš„ç›®æ ‡æœåŠ¡å™¨ï¼Œé»˜è®¤dockerå†…ç½®DNS | `127.0.0.11`     |
| `-P`   | `--port`        | `LISTEN_PORT`    | è®¾ç½®æœåŠ¡çš„ç›‘å¬ç«¯å£                                           | `53`             |
| `-K`   | `--keep-suffix` | `KEEP_SUFFIX`    | æŽ§åˆ¶è½¬å‘DNSæŸ¥è¯¢æ—¶æ˜¯å¦ä¿ç•™åŽç¼€ï¼Œè½¬å‘åˆ°`127.0.0.11`æ—¶åº”åŽ»é™¤åŽç¼€ | -                |
| `-M`   | `--max-hops`    | `MAX_HOPS`       | è®¾ç½®DNSæŸ¥è¯¢çš„æœ€å¤§è·³è½¬ï¼ˆ hop ï¼‰æ¬¡æ•°ï¼Œé˜²æ­¢å¾ªçŽ¯æŸ¥è¯¢             | `3`              |
| `-W`   | `--workers`     | `NUM_WORKERS`    | è®¾ç½®æœåŠ¡çš„å·¥ä½œçº¿ç¨‹æ•°                                         | `4`              |
| `-f`   | `--foreground`  | -                | ä»¥â€œå‰å°æ¨¡å¼â€è¿è¡ŒæœåŠ¡ï¼ˆä¸è½¬å…¥åŽå°å®ˆæŠ¤è¿›ç¨‹ï¼‰                   | æœªå¯ç”¨(é»˜è®¤åŽå°) |
| `-h`   | `--help`        | -                | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼ˆå³å½“å‰é€‰é¡¹åˆ—è¡¨åŠè¯´æ˜Žï¼‰ï¼Œç„¶åŽé€€å‡ºå‘½ä»¤           | -                |

```bash
root@VM-4-2-debian:~# ./docker-dns/docker-dns -h
Usage: ./docker-dns [OPTIONS]
Options:
  -L, --log-level    Set log level (DEBUG, default: INFO, WARN, ERROR, FATAL)
  -G, --gateway      Set gateway name (default: gateway)
  -S, --suffix       Set suffix name (default: .docker)
  -C, --container    Set container name (default: docker-dns)
  -D, --dns-server   Set forward DNS server (default: 127.0.0.11)
  -P, --port         Set listening port (default: 53)
  -K, --keep-suffix  keep suffix forward dns query (default: strip)
  -M, --max-hops     Set maximum hop count (default: 3)
  -W, --workers      Set number of worker threads (default: 4)
  -f, --foreground   Run in foreground mode (do not daemonize)
  -h, --help         Show this help message and exit

Environment variable:
  Command-line arguments take precedence over environment variables.
  --log-level    =>  LOG_LEVEL
  --gateway      =>  GATEWAY_NAME
  --suffix       =>  SUFFIX_DOMAIN
  --container    =>  CONTAINER_NAME
  --dns-server   =>  FORWARD_DNS
  --port         =>  LISTEN_PORT
  --keep-suffix  =>  KEEP_SUFFIX
  --max-hops     =>  MAX_HOPS
  --workers      =>  NUM_WORKERS

```

---
